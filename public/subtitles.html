<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Subtool</title>
    <meta name="description" content="Reimplementation of Captain Claw (1997) platformer">

    <meta property="og:title" content="OpenClaw project">
    <meta property="og:description" content="OpenClaw open source project">
    <!--<meta property="og:image" content="preview.png">-->

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
            integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
            crossorigin="anonymous"></script>
</head>
<body>

<div class="container">
    <nav>
        <div class="nav nav-tabs">
            <a class="nav-item nav-link active" data-toggle="tab" href="#nav-convert">Converter</a>
            <a class="nav-item nav-link" data-toggle="tab" href="#nav-merge">Merger</a>
        </div>
    </nav>
    <div class="tab-content">
        <div class="tab-pane fade show active" id="nav-convert">
            <form>
                <div class="form-group">
                    <label for="top_file">Subtitle file<span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="top_file">
                </div>
                <div class="form-group">
                    <label for="exampleInputPassword1">FPS (Frames per Second)</label>
                    <input type="number" class="form-control" id="exampleInputPassword1">
                    <small class="form-text text-muted">
                        Some types of subtitles store frames. Leave it blank if you are not sure. The system asks you if
                        it will be needed.
                    </small>
                </div>
                <div class="form-group">
                    <label for="fileEncoding">File encoding</label>
                    <input type="text" class="form-control" id="fileEncoding">
                    <small class="form-text text-muted">
                        Leave it blank and the system will try to detect encoding.
                    </small>
                </div>
                <button type="button" class="btn btn-primary" onclick="uploadText(document.getElementById('top_file'))">
                    Convert to SubRip
                </button>
            </form>
            <div class="card text-center">
                <div class="card-header">
                    <nav>
                        <div class="nav nav-tabs card-header-tabs">
                            <a class="nav-item nav-link active" data-toggle="tab" href="#nav-convert-general">General</a>
                            <a class="nav-item nav-link" data-toggle="tab" href="#nav-convert-preview">Preview</a>
                        </div>
                    </nav>
                </div>
                <div class="card-body">
                    <div class="tab-pane fade show active" id="nav-convert-general">
                        <h5 class="card-title">Special title treatment</h5>
                        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                        <a href="#" class="btn btn-primary">Download</a>
                    </div>
                    <div class="tab-pane fade" id="nav-convert-preview">
                        <table class="table table-hover table-sm">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Start</th>
                                <th scope="col">End</th>
                                <th scope="col">Lines</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>00:00:03.125</td>
                                <td>00:01:05.000</td>
                                <td>Hello my</td>
                            </tr>
                            <tr>
                                <th scope="row">2</th>
                                <td>Jacob</td>
                                <td>Thornton</td>
                                <td>friend!</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="nav-merge">
            WORK IN PROGRESS...
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jschardet/2.1.1/jschardet.min.js"
        integrity="sha256-d1wMSNuqcgjqZOAMa9FAhoWU77KgTrPsob0JVcd8ruA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/1.0.30/encoding.min.js"
        integrity="sha256-3N1q3S/Cg/TL0ER062kNT2VYIsHLzEqymlj2dEXYhXI=" crossorigin="anonymous"></script>
<script type='text/javascript'>

    var Module = {
        print: function (text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            console.log(text);
        },
        printErr: function (text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            console.error(text);
        }
    };

    function uploadText(fileInput) {
        var files = fileInput.files;
        if (files.length) {
            var f = files[0];

            read_bytes(f, buf => {
                console.debug("Original size: " + buf.length);

                var encoding = detect_encoding(buf);
                console.debug("Detected encoding: " + encoding);

                read_text(f, encoding, str => {

                    delete window.parsed;
                    var content = mallocStr(str);
                    var fps = 0.0;
                    var code = Module.ccall('parse',
                        'number', // return type
                        ['number', 'number', 'number'], // argument types
                        [content.content, content.size - 1, fps]); // arguments
                    freeStr(content);

                    if (code === 0 || !parsed) {
                        console.log("JS! Format: " + parsed.type);
                    } else {
                        if (code === -3) {
                            console.error("JS! FPS must be set!");
                        } else if (code === -4) {
                            console.error("JS! Unknown subtitle format");
                        } else {
                            console.error("JS! Error code: " + code);
                        }
                    }

                    // var uint8array = new TextEncoder("utf-8").encode(str);
                    // // var string = new TextDecoder().decode(uint8array);
                    // console.debug("UTF-8 byte array size: " + uint8array.length)
                });
            });
        }
    }

    function mallocStr(str) {
        var lengthBytes = lengthBytesUTF8(str) + 1;
        var stringOnWasmHeap = _malloc(lengthBytes);
        stringToUTF8(str, stringOnWasmHeap, lengthBytes);
        return {content: stringOnWasmHeap, size: lengthBytes};
    }

    function freeStr(str) {
        _free(str.content);
    }

    function read_bytes(file, callback) {
        var reader = new FileReader();
        reader.onloadend = (evt) => {
            if (evt.target.readyState === FileReader.DONE) {
                callback(new Uint8Array(evt.target.result));
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function read_text(file, encoding, callback) {
        var reader = new FileReader();
        reader.onloadend = (evt) => {
            if (evt.target.readyState === FileReader.DONE) {
                callback(evt.target.result);
            }
        };
        reader.readAsText(file, encoding);
    }

    function detect_encoding(array) {
        var str = Encoding.convert(array, {
            to: 'UTF8',
            type: 'string'
        });
        return jschardet.detect(str).encoding;
    }

    function download(data, filename) {
        const fileContent = new Blob([data], {type: 'text/plain'});
        if (window.navigator.msSaveOrOpenBlob) { // IE10+
            window.navigator.msSaveOrOpenBlob(fileContent, filename);
        } else {
            const a = document.createElement('a');
            const url = URL.createObjectURL(fileContent);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
    }


    function load() {
        var script = document.createElement("script");
        script.async = !0;
        script.type = "text/javascript";
        script.src = "subtitles.js";
        script.onerror = function (t) {
            console.error("Script Error");
            console.error(t);
        };
        var r = document.getElementsByTagName("script")[0];
        r.parentNode.insertBefore(script, r);
    }

    load();
</script>
</body>
</html>